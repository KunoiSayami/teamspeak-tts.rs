<!DOCTYPE html>
<html>

<head>
   <title>TTS</title>
</head>
<script src="/mstts.js?time=20240825"></script>
<script>
   'use strict';

   function submitWebsocket() {
      let headMessage = document.getElementById("head-message");
      let status = document.getElementById("status");
      let value = document.getElementById("text").value;
      let sex = document.getElementById("sex").value;
      let code = document.getElementById("code").value;
      let variant = document.getElementById("variant").value;
      ws.sendMessage(JSON.stringify({ content: value, sex: sex, code: code, variant: variant }));
   }

   function clearText() {
      document.getElementById("text").value = "";
   }

   function saveText() {
      let value = document.getElementById("text").value;
      window.localStorage.setItem("tts", value);
      setTimeout(saveText, 3000);
   }

   function buildOption(element) {
      let ret = document.createElement("option");
      ret.key = element;
      ret.innerHTML = element;
      return ret;
   }

   function saveVariant() {
      let sex = document.getElementById("sex");
      let code = document.getElementById("code");
      let variant = document.getElementById("variant");

      window.localStorage.setItem("tts-variant", JSON.stringify({
         sex: sex.value, code: code.value, variant: variant.value
      }));
   }

   function getVariant() {
      let x = window.localStorage.getItem("tts-variant");
      if (x != null) {
         return JSON.parse(x);
      }
      return { sex: "Female", code: "en-US", variant: "" };
   }

   function initOptions() {
      let sex = document.getElementById("sex");
      let code = document.getElementById("code");
      let variant = document.getElementById("variant");
      for (let [item, _] of Object.entries(MSTTS)) {
         sex.appendChild(buildOption(item));
      }
      const updateVariant = () => {
         variant.innerHTML = '';
         for (let item of MSTTS[sex.value][code.value]) {
            variant.appendChild(buildOption(item));
         }
      };
      const updateCode = () => {
         code.innerHTML = '';
         for (let [item, _] of Object.entries(MSTTS[sex.value])) {
            code.appendChild(buildOption(item));
         }
         updateVariant();
      }
      let store = getVariant();
      sex.value = store.sex;
      updateCode();
      code.value = store.code;
      updateVariant();
      variant.value = store.variant;

      sex.addEventListener('change', () => {
         updateCode();
         saveVariant();
      });
      code.addEventListener('change', () => {
         updateVariant();
         saveVariant();
      });
      variant.addEventListener('change', saveVariant);
   }

   const ws = () => { };

   const genContent = (content) => {
      return new Date().toLocaleString() + " " + content + "\n";
   }
   ws.showConnected = () => {
      const element = document.getElementById("ws-status");
      element.innerText = "⬤ Connected";
      element.style.color = "green";
   }
   ws.showDisconnected = () => {
      const element = document.getElementById("ws-status");
      element.innerText = "⬤ Disconnected";
      element.style.color = "red";
   }


   const getTime = () => {
      const time = new Date();
      return time.getFullYear() + '-' + time.getMonth() + '-' + time.getDay() + ' ' +
         time.getHours() + ':' + time.getMinutes() + ':' + time.getSeconds() + '.' + time.getMilliseconds();
   }

   ws.appendLog = (content) => {
      document.getElementById("logs").value += getTime() + " " + content + "\n";
   }

   ws.onOpen = (_evt) => {
      console.info('[WS] Connected');
      ws.appendLog("Websocket connected");
      ws.showConnected();
   }

   ws.onMessage = (evt) => {
      console.log(evt);
      ws.appendLog(evt.data);
   }

   ws.onError = (evt) => {
      console.error('[WS] Error => ' + evt.data);
      ws.appendLog("Websocket error => " + evt.data);
      try {
         websocket.close();
      } catch (e) {
      }
      ws.showDisconnected();
      websocket = null;
   }

   ws.onClose = (_evt) => {
      console.info('[WS] Disconnected');
      ws.appendLog("Websocket disconnected");
      ws.showDisconnected();
      websocket = null;
   }

   let websocket = null;
   const REMOTE_ENDPOINT = "/ws";

   ws.sendMessage = (message, retries = 3) => {
      if (websocket === null) {
         ws.create_websocket_connect(REMOTE_ENDPOINT);
         if (retries > 0) {
            setTimeout(ws.sendMessage, 500, message, retries - 1);
         }
      }
      websocket.send(message);
   }

   ws.create_websocket_connect = function (url) {
      if (websocket !== null &&
         (websocket.readyState !== WebSocket.CLOSED ||
            websocket.readyState !== WebSocket.CLOSING)) {
         return;
      }
      websocket = new WebSocket(url);
      websocket.onopen = ws.onOpen;
      websocket.onclose = ws.onClose;
      websocket.onmessage = ws.onMessage;
      websocket.onerror = ws.onError;
   }

   ws.disconnect = function () {
      if (websocket === null) {
         return;
      }
      ws.sendMessage(JSON.stringify({ content: "cLoSe ConneCtion!", code: "", sex: "", variant: "" }));
      try {
         websocket.close();
      } catch (e) {
         console.error(e);
      }
      websocket = null;
   }

   document.addEventListener("DOMContentLoaded", function (event) {
      let textarea = document.getElementById("text");
      let s = window.localStorage.getItem("tts");
      if (s !== null) {
         textarea.value = s;
      }
      setTimeout(saveText, 3000);

      // https://stackoverflow.com/questions/1684196/
      textarea.addEventListener('keydown', e => { if (e.ctrlKey && e.keyCode === 13) submit(); })

      ws.showDisconnected();
      initOptions();
      ws.create_websocket_connect(REMOTE_ENDPOINT);

      window.addEventListener("beforeunload", (_e) => {
         ws.disconnect();
      });
   });
</script>

<body>
   <span id="ws-status"></span>
   <br />
   <select id="sex"></select><select id="code"></select><select id="variant"></select>
   <br />
   <textarea id="text" rows="5" cols="60" name="content"></textarea>
   <br />
   <button onclick="submitWebsocket()">submit</button>
   <button onclick="clearText()">clear</button>
   <br />
   <br />
   logs:<br />
   <textarea id="logs" rows="15" cols="60" readonly></textarea>
</body>

</html>